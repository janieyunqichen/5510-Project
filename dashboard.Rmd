---
title: "Presentation for Country Fire Condition"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(sf)
library(readxl)
library(tidyverse)
library(leaflet)
library(plotly)
library(hrbrthemes)
```

Q7: Distribution and destruction {data-icon="fa-smile-o"}
=============================
Column {data-width=550}
-----------------------------------------------------------------------

### The threatened species distribution

```{r}
protected_species <- read_sf(here::here("data/snes_public_grids_08Aug2019_shapefile/snes_species_combined.shp")) %>%
  select(sci_name, comm_name,threatened, tax_class, tax_king, geometry)
```

```{r}
affected_species <- read_excel("data/protected-species-in-fire-affected-areas-20Jan.xlsx", sheet = 1, range= "C47:I378") %>%
  rename(sci_name = "Scientific Name\r\nwith links to  Species Profile and Threats (SPRAT) database for map and conservation documents",
         comm_name = "Common Name",
         affected_area = "Percentage of the species modelled likely and known distribution within fire affected areas",
         threatened_status = "EPBC Act listed Threatened Status")%>%
  select(sci_name, comm_name, affected_area, threatened_status)

# join affected_species with species
bushfire_species <- affected_species %>%
  left_join(protected_species, by = c("sci_name"))
```

```{r}
distribution_species <- bushfire_species%>%
  mutate(centroid = map(geometry, ~setNames(st_centroid(.x), c("x", "y")))) %>%
   unnest_wider(centroid)
```

```{r}
color <- colorFactor("Paired", distribution_species$tax_class)
leaflet(data = distribution_species)%>%
  addTiles()%>%
  fitBounds(130, -40, 150,-10)%>%
  addCircles(~x, ~y,
             popup = ~(sci_name),
             color = ~color(tax_class))%>%
  addLegend("bottomright", pal = color, values = ~tax_class, 
            title = NULL, opacity = 0.6)
  
```

Column {.tabset data-width=450}
-----------------------------------------------------------------------

### by spatial overlap

```{r dataSummary1, message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# summary of the affected species
overlap_summary <- read_excel("data/protected-species-in-fire-affected-areas-20Jan.xlsx", sheet = 2, range = "B13:J17")%>%
  rename(Spatial_overlap = "Spatial Overlap")%>%
  pivot_longer(cols = Bird: Spider,
               names_to = "Species",
               values_to = "Count_overlap")
p1 <- ggplot(overlap_summary,
       aes(Spatial_overlap, Count_overlap,
           fill = Species))+
  geom_col(position = "identity",
            alpha = 0.8)+
  scale_fill_brewer(palette = "PuBu")+
  xlab("Spatial overlap")+
  ylab("count")+
  theme_bw()
ggplotly(p1)
```

### by threantened condition

```{r , message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
category_summary <- read_excel("data/protected-species-in-fire-affected-areas-20Jan.xlsx", sheet = 2, range = "B22:J26")%>%
  rename(Threatened = "...1")%>%
  pivot_longer(cols = Bird: Spider,
               names_to = "Species",
               values_to = "Count_category")
 p2<-ggplot(category_summary, aes(Threatened, Species, fill= Count_category)) + 
  geom_tile(alpha = 0.6)+
  scale_fill_distiller(palette = "PuBu") +
  labs(x="", y="")+
  theme_ipsum()
ggplotly(p2)
```